---
// Restaurant carousel component
import ImageMod from "@/layouts/components/ImageMod.astro";

// Restaurant image list
const restaurantImages = [
  "restaurant.jpg",
  "restaurant-1.jpg",
  "restaurant-2.jpg",
  "restaurant-3.jpg",
  "restaurant-4.jpg",
  "restaurant-5.jpg",
  "restaurant-6.jpg",
  "restaurant-7.jpg",
  "restaurant-8.jpg",
  "restaurant-9.jpg",
];

// Function to select random images
function getRandomImages(images: string[], count: number): string[] {
  const shuffled = [...images].sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count);
}

// Select all images and duplicate them for infinite effect
const selectedImages = restaurantImages;
---

<section class="py-8 w-screen">
  <div class="relative overflow-hidden carousel-wrapper">
    <button class="nav-button prev" aria-label="Imagen anterior" type="button"
      >‹</button
    >
    <button class="nav-button next" aria-label="Imagen siguiente" type="button"
      >›</button
    >
    <div class="carousel-container flex gap-4" id="restaurant-carousel">
      {
        selectedImages.map((image, index) => (
          <div class="flex-shrink-0 w-full sm:w-1/2 md:w-1/3 lg:w-1/4 h-80 carousel-item">
            <ImageMod
              src={`/images/restaurant/${image}`}
              alt={`Imagen del restaurante ${index + 1}`}
              width={350}
              height={280}
              class="w-full h-full object-cover rounded-lg shadow-lg"
              format="webp"
              aboveTheFold={true}
              data-src={`/images/restaurant/${image}`}
            />
          </div>
        ))
      }
      <!-- Duplicate images for infinite effect -->
      {
        selectedImages.map((image, index) => (
          <div class="flex-shrink-0 w-full sm:w-1/2 md:w-1/3 lg:w-1/4 h-80 carousel-item">
            <ImageMod
              src={`/images/restaurant/${image}`}
              alt={`Imagen del restaurante ${index + 11}`}
              width={350}
              height={280}
              class="w-full h-full object-cover rounded-lg shadow-lg"
              format="webp"
              aboveTheFold={false}
              data-src={`/images/restaurant/${image}`}
            />
          </div>
        ))
      }
      <!-- Third copy for more buffer -->
      {
        selectedImages.map((image, index) => (
          <div class="flex-shrink-0 w-full sm:w-1/2 md:w-1/3 lg:w-1/4 h-80 carousel-item">
            <ImageMod
              src={`/images/restaurant/${image}`}
              alt={`Imagen del restaurante ${index + 21}`}
              width={350}
              height={280}
              class="w-full h-full object-cover rounded-lg shadow-lg"
              format="webp"
              aboveTheFold={true}
              data-src={`/images/restaurant/${image}`}
            />
          </div>
        ))
      }
    </div>
  </div>

  <!-- Zoom Modal -->
  <div id="restaurant-zoom-modal" class="zoom-modal">
    <div class="zoom-overlay"></div>
    <button class="zoom-close" aria-label="Cerrar">&times;</button>
    <img
      id="restaurant-zoom-image"
      class="zoom-content"
      src=""
      alt="Imagen ampliada"
    />
  </div>
</section>

<script>
  // Function to initialize the carousel
  function initRestaurantCarousel() {
    const carousel = document.getElementById("restaurant-carousel");
    const prevBtn = document.querySelector(".nav-button.prev");
    const nextBtn = document.querySelector(".nav-button.next");
    const items = document.querySelectorAll(".carousel-item");

    if (!carousel || !prevBtn || !nextBtn || items.length === 0) return;

    let currentPosition = 0;
    let speed = 0.5; // pixels per frame, adjust for smoothness
    let itemWidth = 0;
    let totalWidth = 0;
    let animationId: number | null = null;

    // Calculate dimensions after layout
    function calculateDimensions() {
      itemWidth = (items[0] as HTMLElement).offsetWidth;
      totalWidth = itemWidth * 30; // 30 items total
    }

    // Move carousel function
    function moveCarousel() {
      currentPosition -= speed;

      // Handle infinite loop
      if (currentPosition <= -totalWidth / 3) {
        currentPosition = 0;
      } else if (currentPosition >= 0 && speed < 0) {
        currentPosition = -totalWidth / 3;
      }

      if (carousel)
        carousel.style.transform = `translateX(${currentPosition}px)`;
      animationId = requestAnimationFrame(moveCarousel);
    }

    // Start animation
    function startAnimation() {
      if (!animationId) {
        calculateDimensions();
        moveCarousel();
      }
    }

    // Stop animation
    function stopAnimation() {
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    const isMobile = window.innerWidth < 768;

    if (!isMobile) {
      // Event listeners for buttons
      prevBtn.addEventListener("mousedown", () => {
        speed = -5; // Reverse while pressed
      });
      prevBtn.addEventListener("mouseup", () => {
        speed = 0.5; // Resume normal
      });
      prevBtn.addEventListener("mouseleave", () => {
        speed = 0.5; // Resume if mouse leaves
      });
      prevBtn.addEventListener("touchstart", () => {
        speed = -1;
      });
      prevBtn.addEventListener("touchend", () => {
        speed = 0.5;
      });

      nextBtn.addEventListener("mousedown", () => {
        speed = 5; // Forward while pressed
      });
      nextBtn.addEventListener("mouseup", () => {
        speed = 0.5;
      });
      nextBtn.addEventListener("mouseleave", () => {
        speed = 0.5;
      });
      nextBtn.addEventListener("touchstart", () => {
        speed = 5;
      });
      nextBtn.addEventListener("touchend", () => {
        speed = 0.5;
      });

      // Start continuous animation on desktop
      startAnimation();
    }

    // Touch/swipe handling
    let startX = 0;
    let initialPosition = 0;
    let isDragging = false;

    carousel.addEventListener("touchstart", (e) => {
      startX = e.touches[0].clientX;
      initialPosition = currentPosition;
      isDragging = true;
      carousel.style.transition = "none";
      if (!isMobile) {
        stopAnimation();
      }
    });

    carousel.addEventListener("touchmove", (e) => {
      if (!isDragging) return;
      e.preventDefault();
      const currentX = e.touches[0].clientX;
      const deltaX = currentX - startX;
      const newPosition = initialPosition + deltaX;
      carousel.style.transform = `translateX(${newPosition}px)`;
    });

    carousel.addEventListener("touchend", (e) => {
      if (!isDragging) return;
      isDragging = false;
      const endX = e.changedTouches[0].clientX;
      const deltaX = endX - startX;

      // Update the current position permanently
      currentPosition = initialPosition + deltaX;

      // Handle infinite loop boundaries
      calculateDimensions();
      if (currentPosition > 0) {
        currentPosition -= totalWidth / 3;
      } else if (currentPosition <= -totalWidth / 3) {
        currentPosition += totalWidth / 3;
      }

      // Remove transition and apply position
      carousel.style.transition = "none";
      carousel.style.transform = `translateX(${currentPosition}px)`;

      if (!isMobile) {
        startAnimation();
      }
    });

    // Zoom functionality
    items.forEach((item) => {
      const img = item.querySelector("img");
      if (img) {
        img.style.cursor = "pointer";
        img.addEventListener("click", (e) => {
          e.stopPropagation();
          const modal = document.getElementById("restaurant-zoom-modal");
          const zoomImg = document.getElementById(
            "restaurant-zoom-image",
          ) as HTMLImageElement;
          // Use optimized image for zoom
          zoomImg.src = img.src;
          modal?.classList.add("active");
        });
      }
    });

    // Close modal
    const modal = document.getElementById("restaurant-zoom-modal");
    const closeBtn = modal?.querySelector(".zoom-close");
    const overlay = modal?.querySelector(".zoom-overlay");
    const zoomImg = modal?.querySelector("#restaurant-zoom-image");
    overlay?.addEventListener("click", () => {
      modal?.classList.remove("active");
    });
    closeBtn?.addEventListener("click", () => {
      modal?.classList.remove("active");
    });
    zoomImg?.addEventListener("click", () => {
      modal?.classList.remove("active");
    });

    // Close on ESC key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal?.classList.contains("active")) {
        modal.classList.remove("active");
      }
    });
  }

  // Initialize on page load and after view transitions
  document.addEventListener("astro:page-load", initRestaurantCarousel);
</script>

<style>
  .carousel-container {
    /* Removed infinite animation, now controlled by JS */
    will-change: transform;
  }

  /* Navigation buttons */
  .nav-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(223, 109, 45, 0.9);
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    opacity: 0;
    font-size: 24px;
    font-weight: bold;
  }

  .carousel-wrapper:hover .nav-button {
    opacity: 1;
  }

  .nav-button:hover {
    background: rgba(223, 109, 45, 1);
    transform: translateY(-50%) scale(1.1);
  }

  .nav-button.prev {
    left: 20px;
  }

  .nav-button.next {
    right: 20px;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .carousel-container > div {
      height: 240px;
    }

    .nav-button {
      display: none;
    }

    .carousel-container {
      transition: transform 0.3s ease;
    }
  }

  @media (max-width: 480px) {
    .carousel-container > div {
      height: 200px;
    }

    .nav-button {
      width: 40px;
      height: 40px;
      font-size: 18px;
    }
  }

  /* Zoom Modal Styles */
  .zoom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    display: none;
    z-index: 1000;
  }

  .zoom-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .zoom-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    pointer-events: auto;
  }

  .zoom-content {
    width: 70vw;
    height: 70vh;
    object-fit: contain;
    z-index: 1001;
    position: relative;
  }

  .zoom-close {
    position: absolute;
    top: 2rem;
    right: 3rem;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 24px;
    z-index: 1002;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .zoom-close:hover {
    background: rgba(0, 0, 0, 0.8);
  }
</style>
